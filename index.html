<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SupportLive Agent Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    #chat-window::-webkit-scrollbar, #clientList::-webkit-scrollbar { width: 8px; }
    #chat-window::-webkit-scrollbar-thumb, #clientList::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
    .timestamp { font-size: 0.7rem; color: #6b7280; margin-top: 2px; user-select: none; }
    .chat-image, .chat-video { max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 4px; cursor: pointer; object-fit: cover; }
    .chat-file-link { color: #2563eb; text-decoration: underline; margin-top: 4px; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
    .chat-file-link i { font-size: 1rem; }
  </style>
</head>
<body class="h-screen bg-gray-100 flex flex-col">

<!-- LOGIN MODAL -->
<div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-8 rounded-lg w-96 flex flex-col gap-4">
    <h1 class="text-2xl font-bold text-center">Agent Login</h1>
    <input type="text" id="loginUsername" placeholder="Username" class="border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-600">
    <input type="password" id="loginPassword" placeholder="Password" class="border rounded px-3 py-2 focus:ring-2 focus:ring-indigo-600">
    <button id="loginBtn" class="bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">Login</button>
    <div id="loginError" class="text-red-500 text-sm text-center hidden">Invalid username or password</div>
  </div>
</div>

<!-- AGENT PORTAL -->
<div id="agentPortal" class="hidden flex-1 h-screen flex">
  <!-- Sidebar -->
  <aside class="w-80 bg-gray-800 text-gray-100 flex flex-col">
    <div class="flex items-center justify-center h-16 border-b border-gray-700">
      <h1 class="text-xl font-bold">Agent Dashboard</h1>
    </div>
    <div class="p-4">
      <input id="searchClient" type="text" placeholder="Search clients..." class="w-full px-3 py-2 rounded focus:ring-2 focus:ring-indigo-600 text-gray-800">
    </div>
    <ul id="clientList" class="flex-1 overflow-y-auto divide-y divide-gray-700"></ul>
    <div class="p-4 border-t border-gray-700">
      <div id="agentInfo" class="text-sm mb-2"></div>
      <button id="logoutBtn" class="w-full py-2 bg-red-600 rounded hover:bg-red-700">Logout</button>
    </div>
  </aside>

  <!-- Chat Window -->
  <main class="flex-1 flex flex-col bg-white">
    <div id="chatHeader" class="flex-shrink-0 h-16 border-b border-gray-300 px-6 py-4 flex items-center justify-between">
      <span id="activeClientTitle">Select a client</span>
    </div>
    <div id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-4 flex flex-col bg-gray-50"></div>
    <form id="chatForm" class="flex border-t border-gray-300 p-4 gap-4 items-center hidden">
      <input id="chatInput" type="text" placeholder="Type a message..." class="flex-grow border rounded px-4 py-2 focus:ring-2 focus:ring-indigo-600">
      <input id="fileInput" type="file" class="hidden" accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
      <button type="button" id="fileBtn" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-paperclip fa-lg"></i></button>
      <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition">Send</button>
    </form>
  </main>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const apiBase = 'http://localhost:3001/api';
let agent = null;
let clients = {};
let activeClient = null;

// Elements
const loginModal = document.getElementById('loginModal');
const agentPortal = document.getElementById('agentPortal');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const loginUsername = document.getElementById('loginUsername');
const loginPassword = document.getElementById('loginPassword');

const clientListEl = document.getElementById('clientList');
const chatWindow = document.getElementById('chat-window');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');
const fileInput = document.getElementById('fileInput');
const fileBtn = document.getElementById('fileBtn');
const activeClientTitle = document.getElementById('activeClientTitle');
const searchClient = document.getElementById('searchClient');
const logoutBtn = document.getElementById('logoutBtn');
const agentInfo = document.getElementById('agentInfo');

let socket;

// --- Helper Functions ---
function maskPhone(phone) { if(phone.length<=4) return phone; return phone.slice(0,4)+'****'+phone.slice(-3); }
function formatTimestamp(date){ const d=new Date(date); let hours=d.getHours(); const minutes=d.getMinutes().toString().padStart(2,'0'); const ampm=hours>=12?'PM':'AM'; hours=hours%12||12; return `${hours}:${minutes} ${ampm}`; }

// --- Login ---
async function login(username, password){
  loginError.classList.add('hidden');
  try{
    const res = await fetch(`${apiBase}/agent/login`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ username, password })
    });
    const data = await res.json();
    if(data.success){
      agent = data.agent;
      localStorage.setItem('agent', JSON.stringify(agent));
      showAgentPortal();
      initPortal();
    } else {
      loginError.textContent = data.message || 'Invalid username or password';
      loginError.classList.remove('hidden');
    }
  } catch(err){ console.error(err); loginError.classList.remove('hidden'); }
}

// Show Portal
function showAgentPortal(){
  agentInfo.textContent = agent.username;
  loginModal.classList.add('hidden');
  agentPortal.classList.remove('hidden');
}

// Logout
logoutBtn.addEventListener('click', () => {
  agent=null; activeClient=null;
  localStorage.removeItem('agent');
  loginModal.classList.remove('hidden');
  agentPortal.classList.add('hidden');
  chatWindow.innerHTML='';
  clientListEl.innerHTML='';
  if(socket) socket.disconnect();
});

// Auto-login
window.addEventListener('load', ()=>{
  const storedAgent = localStorage.getItem('agent');
  if(storedAgent){
    agent = JSON.parse(storedAgent);
    showAgentPortal();
    initPortal();
  }
});

// Login button
loginBtn.addEventListener('click', ()=>{
  const username = loginUsername.value.trim();
  const password = loginPassword.value.trim();
  if(!username||!password) return;
  login(username,password);
});

// --- Portal Initialization ---
async function initPortal(){
  socket = io(apiBase.replace('/api',''));
  socket.on('chat message', msg => handleIncomingMessage(msg));
  chatForm.classList.remove('hidden');
  await loadClients();

  searchClient.addEventListener('input', ()=>renderClients(searchClient.value));

  chatForm.addEventListener('submit', async e=>{
    e.preventDefault();
    if(!activeClient) return;
    const text = chatInput.value.trim();
    if(!text) return;
    try{
      const res = await fetch(`${apiBase}/admin/send-message`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ phone:activeClient.phone, text })
      });
      const data = await res.json();
      if(data.success){
        addMessage({ text, sender:'Admin', timestamp:new Date() }, activeClient.phone);
        chatInput.value='';
      }
    } catch(err){ console.error(err); }
  });

  fileBtn.addEventListener('click', ()=>{ if(!activeClient) return; fileInput.click(); });
  fileInput.addEventListener('change', async ()=>{
    if(!activeClient||!fileInput.files[0]) return;
    const file = fileInput.files[0]; 
    const formData = new FormData();
    formData.append('phone', activeClient.phone); 
    formData.append('file', file);
    try{
      const res = await fetch(`${apiBase}/admin/send-file`, { method:'POST', body:formData });
      const data = await res.json();
      if(data.success) addMessage({ text:'', sender:'Admin', isFile:true, fileUrl:data.fileUrl, timestamp:new Date() }, activeClient.phone);
    } catch(err){ console.error(err); }
  });
}

// --- Load Clients ---
async function loadClients(){
  try{
    const res = await fetch(`${apiBase}/chats`);
    const phones = await res.json();
    phones.forEach(p => { if(!clients[p]) clients[p]={ phone:p, messages:[] }; });
    renderClients();
  } catch(err){ console.error(err); }
}

// --- Render Clients ---
function renderClients(filter=''){
  clientListEl.innerHTML='';
  Object.values(clients)
    .filter(c=>maskPhone(c.phone).includes(filter))
    .forEach(c=>{
      const li=document.createElement('li');
      li.className=`p-4 cursor-pointer hover:bg-gray-700 flex flex-col ${activeClient&&activeClient.phone===c.phone?'bg-gray-600':''}`;
      li.innerHTML=`<span class="font-semibold">${maskPhone(c.phone)}</span><span class="text-sm text-gray-300 truncate">${c.messages.length?c.messages[c.messages.length-1].text:''}</span>`;
      li.addEventListener('click', ()=>setActiveClient(c.phone));
      clientListEl.appendChild(li);
    });
}

// --- Set Active Client ---
async function setActiveClient(phone){
  activeClient = clients[phone]; 
  activeClientTitle.textContent = maskPhone(phone); 
  chatWindow.innerHTML='';
  try{
    const res = await fetch(`${apiBase}/chats/${encodeURIComponent(phone)}`);
    const data = await res.json();
    if(data.success){
      activeClient.messages = data.chats.map(c=>({
        text:c.message, 
        sender:c.senderRole==='admin'?'Admin':'Client', 
        timestamp:c.timestamp, 
        isFile:c.isFile, 
        fileUrl:c.fileUrl 
      }));
      activeClient.messages.forEach(m=>addMessage(m, phone));
    }
  } catch(err){ console.error(err); }
}

// --- Add Message ---
function addMessage(msg, phone){
  if(!clients[phone]) clients[phone]={ phone, messages:[] };
  clients[phone].messages.push(msg);
  renderClients(searchClient.value);

  if(activeClient && activeClient.phone===phone){
    const msgDiv=document.createElement('div');
    msgDiv.classList.add('max-w-xs','px-4','py-2','rounded-lg','break-words');
    if(msg.sender==='Admin'){ 
      msgDiv.classList.add('bg-indigo-600','text-white'); 
      msgDiv.style.alignSelf='flex-end'; 
    } else { 
      msgDiv.classList.add('bg-gray-700','text-gray-100'); 
      msgDiv.style.alignSelf='flex-start'; 
    }

    if(msg.isFile){
      if(msg.fileUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)){ 
        const img=document.createElement('img'); img.src=msg.fileUrl; img.className='chat-image'; msgDiv.appendChild(img); 
      } else if(msg.fileUrl.match(/\.(mp4|webm|ogg)$/i)){ 
        const video=document.createElement('video'); video.src=msg.fileUrl; video.controls=true; video.className='chat-video'; msgDiv.appendChild(video); 
      } else { 
        const link=document.createElement('a'); link.href=msg.fileUrl; link.target='_blank'; link.rel='noopener noreferrer'; link.className='chat-file-link'; link.innerHTML='<i class="fas fa-download"></i> Download'; msgDiv.appendChild(link); 
      }
    } else { 
      msgDiv.textContent = `${msg.sender}: ${msg.text}`; 
    }

    const timeEl=document.createElement('div'); 
    timeEl.classList.add('timestamp'); 
    timeEl.textContent=formatTimestamp(msg.timestamp);
    msgDiv.appendChild(timeEl); 
    chatWindow.appendChild(msgDiv); 
    chatWindow.scrollTop=chatWindow.scrollHeight;
  }
}

// --- Handle Incoming Message ---
function handleIncomingMessage(msg){ addMessage(msg, msg.phone); }
</script>
</body>
</html>
